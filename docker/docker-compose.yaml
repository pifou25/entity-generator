version: '3.8'

networks:
  default:
    name: default_network

services:
  db:
    image: mariadb # for rpi3/4: ghcr.io/linuxserver/mariadb
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=my-admin-secret
      - TZ=${TZ:-Europe/Paris}
      - MYSQL_DATABASE=my-database
      - MYSQL_USER=my-username
      - MYSQL_PASSWORD=my-password
    volumes:
      # directory for init sql and scripts
      - ./init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--su-mysql", "--connect", "--innodb_initialized"]
      interval: 1m30s
      timeout: 30s
      retries: 5
      # the start_period is long enough to ensure that init data is fully loaded
      start_period: 30s


  composer:
    image: composer
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - .:/app
    command: require dodo-it/entity-generator


  php:
    image: php:8.2-cli
    depends_on:
      composer:
        condition: service_completed_successfully
    environment:
      - TZ=${TZ:-Europe/Paris}
      - MYSQL_HOSTNAME=db
      - MYSQL_DATABASE=my-database
      - MYSQL_USERNAME=my-username
      - MYSQL_PASSWORD=my-password
    working_dir: /app
    volumes:
      - .:/app
    command: index.php
